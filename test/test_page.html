<!DOCTYPE html>
<html>
<head>
	<title>Aculab Cloud WebRTC demo</title>
	<link rel="icon" type="image/gif" href="/images/favicon.gif" />
	<script type='application/javascript' src='../dist/AculabCloudCaller.js'></script>
	<script type='application/javascript'>
	var acc = null;
	var inbound_enabled = false;
	var auto_accept = false;
	var slots = new Map([
		['a', {'call': null, 'inbound':false, 'connected':false, 'player':null, 'secondplayer':null, 'playing_ringing':false, 'gotremotestream':false, 'remotestream':null, 'gotsecondremotestream':false, 'remotesecondstream':null, 'gotlocalstream':false, 'localstream':null, 'localsecondstream':null}],
		['b', {'call': null, 'inbound':false, 'connected':false, 'player':null, 'secondplayer':null, 'playing_ringing':false, 'gotremotestream':false, 'remotestream':null, 'gotsecondremotestream':false, 'remotesecondstream':null, 'gotlocalstream':false, 'localstream':null, 'localsecondstream':null}],
		['c', {'call': null, 'inbound':false, 'connected':false, 'player':null, 'secondplayer':null, 'playing_ringing':false, 'gotremotestream':false, 'remotestream':null, 'gotsecondremotestream':false, 'remotesecondstream':null, 'gotlocalstream':false, 'localstream':null, 'localsecondstream':null}],
		['d', {'call': null, 'inbound':false, 'connected':false, 'player':null, 'secondplayer':null, 'playing_ringing':false, 'gotremotestream':false, 'remotestream':null, 'gotsecondremotestream':false, 'remotesecondstream':null, 'gotlocalstream':false, 'localstream':null, 'localsecondstream':null}],
	]);
	var statsTimer = null;
	function initialise() {
		const urlParams = new URLSearchParams(window.location.search);
		if (urlParams.get('autoaccept') !== null) {
			auto_accept = true;
		}
		console.log(urlParams.get('autoaccept'));
		const thisUrl = window.location.href;
		if (!thisUrl.startsWith("file://")) {
			/* You can't capture the stream of a video from
			 * files that are served from a local web page.
			 * So only list it as an option if this page
			 * is not served from a file:// URL */
			slots.forEach((_, key) => {
				var sel = document.getElementById(key + "-second-stream-source")
				var opt = document.createElement('option');
				opt.value = "File";
				opt.innerHTML = "File";
				sel.appendChild(opt);
			});
		}
	}
	function startStats() {
		statsTimer = setInterval(()=>{
			for (const [key, value] of slots.entries()) {
				var stat = "No call";
				if (value.call) {
					value.call.getConnectionInfo().then(stat => {
						document.getElementById(key + "-stats").value = stat;
					});
				} else {
					document.getElementById(key + "-stats").value = "No call";
				}
			}
		}, 1000);
	}
	function stopStats() {
		if (statsTimer) {
			clearInterval(statsTimer);
			statsTimer = null;
			for (const [key, value] of slots.entries()) {
				var stat = "No call";
				document.getElementById(key + "-stats").value = stat;
			}
		}
	}
	function reset_slot_obj(slot_obj) {
		slot_obj.gotremotestream = null;
		slot_obj.gotsecondremotestream = null;
		slot_obj.remotesecondstream = null;
		slot_obj.gotlocalstream = null;
		slot_obj.localstream = null;
		slot_obj.localsecondstream = null;
	}
	function show_second_stream(slot, visible) {
		var titles = document.getElementById(slot + "-secondstreamtitle");
		var players = document.getElementById(slot + "-secondstreamplayers");
		var val = "collapse";
		if (visible) {
			val = "visible";
		}

		titles.style.visibility = val;
		players.style.visibility = val;
	}
	function configDtmfButtons(slot, enabled) {
		var dtmf_table = document.getElementById(slot + '-dtmf-buttons');
		var buttons = dtmf_table.getElementsByTagName('button');
		for (var i=0; i < buttons.length; i++) {
			buttons.item(i).disabled = !enabled;
		}
	}
	function gotmedia(slot, obj) {
		var slot_obj = slots.get(slot);
		if (obj !== null) {
			if (!slot_obj.gotremotestream) {
				var player = slot_obj.player;
				slot_obj.remotestream = obj.stream;
			} else {
				show_second_stream(slot, true);
				var player = slot_obj.secondplayer;
				slot_obj.remotesecondstream = obj.stream;
			}
			player.pause();
			player.loop = '';
			player.src = '';
			player.srcObject = null;
			player.type = '';
			player.load();
			// reset the player size
			player.style.width = "320px";
			player.style.height = "240px";
			player.parentElement.classList.remove("muted");
			slot_obj.playing_ringing = false;
			slot_obj.gotremotestream = true;
			player.srcObject = obj.stream;
			player.load();
			var p = player.play();
			if (p !== undefined) {
				p.catch(error => {console.log(error)});
			}
		} else {
			var playerlist = [slot_obj.player, slot_obj.secondplayer];
			playerlist.forEach(player => {
				player.pause();
				player.loop = '';
				player.src = '';
				player.srcObject = null;
				player.type = '';
				player.load();
				player.style.width = "320px";
				player.style.height = "240px";
			});
			slot_obj.gotremotestream = false;
			slot_obj.remotestream = null;
			slot_obj.remotesecondstream = null;
		}
	}
	function mediaremove(slot, obj)
	{
		var slot_obj = slots.get(slot);
		var player = null;
		if (slot_obj.remotesecondstream !== null && obj.stream.id == slot_obj.remotesecondstream.id) {
			player = slot_obj.secondplayer;
		} else if (slot_obj.remotestream !== null && obj.stream.id == slot_obj.remotestream.id) {
			player = slot_obj.player;
		}
		if (player) {
			player.pause();
			player.loop = '';
			player.src = '';
			player.srcObject = null;
			player.type = '';
			player.load();
			player.style.width = "320px";
			player.style.height = "240px";
		}
	}
	function localmediaremove(slot, obj)
	{
		var slot_obj = slots.get(slot);
		var player = null;
		if (slot_obj.localsecondstream !== null && obj.stream.id == slot_obj.localsecondstream.id) {
			player = slot_obj.localsecondplayer;
		} else if (slot_obj.localstream !== null && obj.stream.id == slot_obj.localstream.id) {
			player = slot_obj.localplayer;
		}

		if (player) {
			player.pause();
			player.loop = '';
			player.src = '';
			player.srcObject = null;
			player.type = '';
			player.load();
			player.style.width = "320px";
			player.style.height = "240px";
		}
	}
	function handle_disconnect(slot, cause) {
		var slot_obj = slots.get(slot);
		slot_obj.connected=false;
		if (slot_obj.call != null) {
			slot_obj.call.disconnect();
			slot_obj.call = null;
		}
		gotmedia(slot, null);
		var playerlist = [slot_obj.localplayer, slot_obj.localsecondplayer];
		playerlist.forEach(player => {
			if (player != null) {
				player.pause();
				player.loop = '';
				player.src = '';
				player.srcObject = null;
				player.type = '';
				player.load();
				player.style.width = "320px";
				player.style.height = "240px";
			}
		});
		document.getElementById(slot + "-state").value = "Idle - " + cause;
		document.getElementById(slot + "-callid").value = "(previous) " + document.getElementById(slot + "-callid").value;
		document.getElementById(slot + "-remote").value = "";
		document.getElementById(slot + "-start_button").disabled = false;
		document.getElementById(slot + "-stop_button").disabled = true;
		document.getElementById(slot + "-second_stream_button").disabled = true;
		document.getElementById(slot + "-second_stream_button").innerHTML = "Add Stream";
		document.getElementById(slot + "-mute-mic").disabled = true;
		document.getElementById(slot + "-mute-mic").checked = false;
		document.getElementById(slot + "-mute-cam").disabled = true;
		document.getElementById(slot + "-mute-cam").checked = false;
		document.getElementById(slot + "-mute-outa").disabled = true;
		document.getElementById(slot + "-mute-outa").checked = false;
		document.getElementById(slot + "-mute-outv").disabled = true;
		document.getElementById(slot + "-mute-outv").checked = false;
		document.getElementById(slot + "-target-type").disabled = false;
		document.getElementById(slot + "-target").disabled = false;
		document.getElementById(slot + "-header").disabled = false;
		document.getElementById(slot + "-recv-header").value = "";
		configDtmfButtons(slot, false);
		reset_slot_obj(slot_obj);
		show_second_stream(slot, false);
	}
	function call_disconnected(slot, obj) {
		var slot_obj = slots.get(slot);
		slot_obj.call = null;
		handle_disconnect(slot, obj.cause);
	}
	function connecting(slot, obj) {
		var slot_obj = slots.get(slot);
		document.getElementById(slot + "-state").value = "Connecting";
		document.getElementById(slot + "-callid").value = slot_obj.call.callId();
		var player = slot_obj.localplayer;
		if (obj.stream) {
			if (slot_obj.localstream === null) {
				slot_obj.localstream = obj.stream;
			} else if (slot_obj.localsecondstream === null) {
				player = slot_obj.localsecondplayer;
				slot_obj.localsecondstream = obj.stream;
			} else {
				console.log("Tying to add too may streams");
			}
		}

		if (player) {
			player.srcObject = obj.stream;
			player.load();
			var p = player.play();
			if (p !== undefined) {
				p.catch(error => {});
			}
		}
	}
	function ringing(slot) {
		var slot_obj = slots.get(slot);
		document.getElementById(slot + "-state").value = "Ringing";
		if (!slot_obj.playing_ringing) {
			var player = slot_obj.player;
			if (player.canPlayType('audio/wav')) {
				if (!slot_obj.gotremotestream) {
					player.loop = 'loop';
					player.src = 'media/ringback.wav';
					player.type="audio/wav";
					player.load();
					var p = player.play();
					if (p !== undefined) {
						p.catch(error => {});
					}
				}
			} else {
				console.log("browser can't play audio/wav, so no ringing will be heard");
			}
			slot_obj.playing_ringing = true;
		}
	}
	function connected(slot) {
		var slot_obj = slots.get(slot);
		slot_obj.connected=true;
		if (!slot_obj.gotremotestream) {
			gotmedia(slot, null);
		}
		if (!slot_obj.inbound) {
			var siphdr = slot_obj.call.getSipHeader("X-Aculab-WebRTC-Answer");
			if (siphdr !== undefined) {
				document.getElementById(slot + "-recv-header").value = siphdr;
			}
		}
		document.getElementById(slot + "-state").value = "Connected";
		document.getElementById(slot + "-start_button").disabled = true;
		document.getElementById(slot + "-stop_button").disabled = false;
		if (secondStreamSource(slot) != "None") {
			document.getElementById(slot + "-second_stream_button").disabled = false;
		}
		document.getElementById(slot + "-mute-mic").disabled = false;
		document.getElementById(slot + "-mute-cam").disabled = false;
		document.getElementById(slot + "-mute-outa").disabled = false;
		document.getElementById(slot + "-mute-outv").disabled = false;
		configDtmfButtons(slot, true);
	}
	function handle_error(slot, obj) {
		handle_disconnect(slot, obj.error);
	}
	function mute_call(slot) {
		var slot_obj = slots.get(slot);
		if (slot_obj.call) {
			var mic = document.getElementById(slot + "-mute-mic").checked;
			var cam = document.getElementById(slot + "-mute-cam").checked;
			var outa = document.getElementById(slot + "-mute-outa").checked;
			var outv = document.getElementById(slot + "-mute-outv").checked;
			slot_obj.call.mute(mic, outa, cam, outv);
		}
	}

	function switch_led_colour(slot, type, state) {
        /* Helper function to change the colour of a mic/cam/outa/outv LED light */
        var led = document.getElementById(slot + "-" + type + "-led");
        if (state) {
          led.classList.add("green");
        } else {
          led.classList.remove("green");
        }
    }

    function switch_status_leds(slot){
        /* Checks the status of all tracks in a particular slots and changes the LEDs accordingly */
        var slot_obj = slots.get(slot);
        if (slot_obj.call) {  // there is an ongoing call
            var muted_dict = slot_obj.call.isMuted();
            switch_led_colour(slot, "mic", !muted_dict["mic"]);
            switch_led_colour(slot, "outa", !muted_dict["output_audio"]);
            switch_led_colour(slot, "cam", !muted_dict["camera"]);
            switch_led_colour(slot, "outv", !muted_dict["output_video"]);
        } else {  // no ongoing call
            switch_led_colour(slot, "mic", false);
            switch_led_colour(slot, "outa", false);
            switch_led_colour(slot, "cam", false);
            switch_led_colour(slot, "outv", false);
        }
    }

    /* Check periodically if the call is muted and change the LED colour accordingly */
    var ledsIntervalId = setInterval(function() {
        for (var [slot, obj] of slots) {
            switch_status_leds(slot);
        }
    }, 400);


	function switch_led_colour(slot, type, state) {
        /* Helper function to change the colour of a mic/cam/outa/outv LED light */
        var led = document.getElementById(slot + "-" + type + "-led");
        if (state) {
          led.classList.add("green");
        } else {
          led.classList.remove("green");
        }
    }

    function switch_status_leds(slot){
        /* Checks the status of all tracks in a particular slots and changes the LEDs accordingly */
        var slot_obj = slots.get(slot);
        if (slot_obj.call) {  // there is an ongoing call
            var muted_dict = slot_obj.call.isMuted(slot_obj.remotestream);
            switch_led_colour(slot, "mic", !muted_dict["mic"]);
            switch_led_colour(slot, "outa", !muted_dict["output_audio"]);
            switch_led_colour(slot, "cam", !muted_dict["camera"]);
            switch_led_colour(slot, "outv", !muted_dict["output_video"]);
        } else {  // no ongoing call
            switch_led_colour(slot, "mic", false);
            switch_led_colour(slot, "outa", false);
            switch_led_colour(slot, "cam", false);
            switch_led_colour(slot, "outv", false);
        }
    }

    /* Check periodically if the call is muted and change the LED colour accordingly */
    var ledsIntervalId = setInterval(function() {
        for (var [slot, obj] of slots) {
            switch_status_leds(slot);
        }
    }, 400);


	function get_audio_constraints(slot) {
		let val = document.getElementById(slot + "-audio-constraints").value;
		if (val == "true") {
			return true;
		} else if (val == "false") {
			return false;
		}
		return true; // a default?
	}

	function get_video_constraints(slot) {
		let val = document.getElementById(slot + "-video-constraints").value;
		if (val == "true") {
			return true;
		} else if (val == "false") {
			return false;
		} else if (val == "qvga-exact") {
			return { width: {exact: "320"}, height:{exact: "240"}};
		} else if (val == "qvga-ideal") {
			return { width: "320", height: "240"};
		} else if (val == "vga-exact") {
			return { width: {exact: "640"}, height:{exact: "480"}};
		} else if (val == "vga-ideal") {
			return { width: "640", height: "480"};
		} else if (val == "xga-exact") {
			return { width: {exact: "1024"}, height:{exact: "768"}};
		} else if (val == "xga-ideal") {
			return { width: "1024", height: "768"};
		} else if (val == "hd720-exact") {
			return { width: {exact: "1280"}, height:{exact: "720"}};
		} else if (val == "hd720-ideal") {
			return { width: "1280", height: "720"};
		} else if (val == "hd1080-exact") {
			return { width: {exact: "1920"}, height:{exact: "1080"}};
		} else if (val == "hd1080-ideal") {
			return { width: "1920", height: "1080"};
		}
		return true; // a default?
	}

	function get_receive_setting(slot, type) {
		let sel = document.getElementById(slot + "-" + type + "-receive");
		if (sel) {
			let val = sel.value;
			if (val == "true") {
				return true;
			} else if (val == "false") {
				return false;
			}
		}
		return undefined;
	}

	function get_bandwidth_setting(slot, type) {
		let sel = document.getElementById(slot + "-" + type + "-bandwidth");
		if (sel) {
			let val = sel.value;
			if (val == "unlimited") {
				return Infinity;
			} else if (val == "not set") {
				return undefined;
			}
			return parseInt(val, 10);
		}
		return undefined;
	}

	function set_codec_selector(slot, type) {
		let sel = document.getElementById(slot + "-" + type + "-codecs");
		if (sel) {
			sel.innerHTML = ''; // clear first
			let codecs = AculabCloudClient.getCodecList(type);
			codecs.forEach(codec => {
				if (['video/red', 'video/ulpfec', 'video/rtx', 'audio/CN', 'audio/telephone-event'].includes(codec.mimeType)) {
					return;
				}
				const option = document.createElement('option');
				option.value = (codec.mimeType + ' ' + (codec.sdpFmtpLine || '')).trim();
				option.innerText = option.value;
				sel.appendChild(option);
			});
		}
	}

	function get_codec_selection(slot, type) {
		let sel = document.getElementById(slot + "-" + type + "-codecs");
		let codecs = AculabCloudClient.getCodecList(type);
		if (sel) {
			const [mimeType, sdpFmtpLine] = sel.value.split(' ');
			const selectedCodecIndex = codecs.findIndex(c => c.mimeType === mimeType && c.sdpFmtpLine === sdpFmtpLine);
			const selectedCodec = codecs[selectedCodecIndex];
			codecs.splice(selectedCodecIndex, 1);
			codecs.unshift(selectedCodec);
			console.log("codecs", codecs);
		}
		return codecs;
	}

	async function start_call(slot) {
		var slot_obj = slots.get(slot);
		var exthdr = document.getElementById(slot + "-header").value;
		var opts = {
			constraints: {
				audio: get_audio_constraints(slot),
				video: get_video_constraints(slot),
			},
			receiveAudio: get_receive_setting(slot, "audio"),
			receiveVideo: get_receive_setting(slot, "video"),
			codecs: {
				audio: get_codec_selection(slot, "audio"),
				video: get_codec_selection(slot, "video"),
			},
			maxBitrateAudio: get_bandwidth_setting(slot, 'audio'),
			maxBitrateVideo: get_bandwidth_setting(slot, 'video'),
		}
		if (secondStreamSource(slot) != "None") {
			const mediaStream = await navigator.mediaDevices.getUserMedia(opts.constraints);
			opts.localStreams = [mediaStream];
		}
		if (slot_obj.call) {
			if (slot_obj.inbound && !slot_obj.connected) {
				console.log("accepting inbound");
				document.getElementById(slot + "-state").value = "Accepting call";
				document.getElementById(slot + "-start_button").disabled = true;
				document.getElementById(slot + "-stop_button").disabled = false;
				document.getElementById(slot + "-header").disabled = true;
				if (secondStreamSource(slot) != "None") {
					document.getElementById(slot + "-second_stream_button").disabled = false;
				}
				if (exthdr !== "") {
					if (exthdr.indexOf(":") == -1) {
						exthdr = "X-Aculab-WebRTC-Answer: " + exthdr;
					}
					opts.extraHeaders = [exthdr];
				}
				slot_obj.call.answer(opts);
			} else {
				console.log("not starting call - call in progress");
			}
		} else {
			if (exthdr !== "") {
				if (exthdr.indexOf(":") == -1) {
					exthdr = "X-Aculab-WebRTC-Test: " + exthdr;
				}
				opts.extraHeaders = [exthdr];
			}
			console.log("starting call");
			document.getElementById(slot + "-state").value = "Starting call";
			type = document.getElementById(slot + "-target-type").value;
			targ = document.getElementById(slot + "-target").value;
			if (type == 'client') {
				token = document.getElementById("token").value;
				try {
					slot_obj.call = acc.callClient(encodeURIComponent(targ), token, opts);
				}
				catch(err) {
					alert("Error: " + err);
					return;
				}
			} else {
				slot_obj.call = acc.callService(encodeURIComponent(targ));
			}
			document.getElementById(slot + "-callid").value = '';
			slot_obj.call.onDisconnect = call_disconnected.bind(null, slot);
			slot_obj.call.onRinging = ringing.bind(null, slot);
			slot_obj.call.onMedia = gotmedia.bind(null, slot);
			slot_obj.call.onMediaRemove = mediaremove.bind(null, slot);
			slot_obj.call.onLocalMediaRemove = localmediaremove.bind(null, slot);
			slot_obj.call.onConnecting = connecting.bind(null, slot);
			slot_obj.call.onConnected = connected.bind(null, slot);
			slot_obj.call.onError = handle_error.bind(null, slot);
			slot_obj.call.onLocalVideoMute = handleVideoMuteUnmute.bind(null, slot, "local", "mute");
			slot_obj.call.onLocalVideoUnmute = handleVideoMuteUnmute.bind(null, slot, "local", "unmute");
			slot_obj.call.onRemoteVideoMute = handleVideoMuteUnmute.bind(null, slot, "remote", "mute");
			slot_obj.call.onRemoteVideoUnmute = handleVideoMuteUnmute.bind(null, slot, "remote", "unmute");
			slot_obj.inbound = false;
			document.getElementById(slot + "-remote").value = type + ": " + targ;
			document.getElementById(slot + "-target-type").disabled = true;
			document.getElementById(slot + "-target").disabled = true;
			document.getElementById(slot + "-start_button").disabled = true;
			document.getElementById(slot + "-stop_button").disabled = false;
			if (secondStreamSource(slot) != "None") {
				document.getElementById(slot + "-second_stream_button").disabled = false;
			}
		}
	}
	function stop_call(slot) {
		var slot_obj = slots.get(slot);
		console.log("stopping call");
		if (slot_obj.call) {
			// if inbound and not accepted, use reject instead
			if (slot_obj.inbound && !slot_obj.connected) {
				slot_obj.call.reject(486);
			} else {
				slot_obj.call.disconnect();
			}
		}
		document.getElementById(slot + "-stop_button").disabled = true;
		document.getElementById(slot + "-second_stream_button").disabled = true;
		configDtmfButtons(slot, false);
		if (!slot_obj.connected) {
			document.getElementById(slot + "-start_button").disabled = false;
		}
	}
	async function captureScreen() {
		const displayMediaOptions = {
			video: {
				displaySurface: "window"
			},
			audio: false,
		};
		const screenCapture = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
		return screenCapture;
	}

	function captureStream(player) {
		if (player.captureStream) {
			return player.captureStream(0);
		} else if (player.mozCaptureStream) {
			return player.mozCaptureStream(0);
		}

		return null;
	}
	async function add_remove_stream(slot) {
		if (document.getElementById(slot + "-second_stream_button").innerHTML == "Remove Stream") {
			remove_stream(slot);
		} else {
			add_stream(slot);
		}
	}
	async function remove_stream(slot) {
		var slot_obj = slots.get(slot);
		console.log("Removing second stream ", slot_obj.localsecondstream);
		if (slot_obj.call && slot_obj.localsecondstream) {
			try {
				slot_obj.call.removeStream(slot_obj.localsecondstream);
				slot_obj.localsecondstream = null;
				document.getElementById(slot + "-second_stream_button").innerHTML = "Add Stream";
			} catch(err) {
				window.alert(err);
			}
		}
	}
	async function add_stream(slot) {
		var slot_obj = slots.get(slot);
		var stream_added = false;
		console.log("Adding second stream");
		if (slot_obj.localsecondstream !== null) {
			throw "Second stream is already added";
		}
		if (slot_obj.call) {
			show_second_stream(slot, true);
			const src = secondStreamSource(slot);
			if (src == "None") {
				throw "Second stream not enabled";
			} else if (src == "File") {
				var video = document.createElement("video");
				video.src = "./media/lotus_dancing_in_the_wind_360.mp4";
				video.type = "video/mp4";
				video.load();
				video.loop = 'loop';
				await video.play();
				const newStream = await captureStream(video);
				try {
					slot_obj.call.addStream(newStream);
					stream_added = true;
				} catch(err) {
					window.alert(error);
				}
			} else if (src == "Screen Share") {
				const newStream = await captureScreen();
				try {
					slot_obj.call.addStream(newStream);
					stream_added = true;
				} catch(err) {
					window.alert(error);
				}
			}
			if (stream_added) {
				document.getElementById(slot + "-second_stream_button").innerHTML = "Remove Stream";
			}
		}
	}
	function send_dtmf(slot, dtmf) {
		var slot_obj = slots.get(slot);
		if (slot_obj.call) {
			console.log("send dtmf:" + dtmf);
			slot_obj.call.sendDtmf(dtmf);
		}
	}
	function handleVideoMuteUnmute(slot, loc, change, obj) {
		console.log("slot " + slot + ": " + loc + " video " + change + " [call: " + obj.call + ", stream: " + obj.stream + ", track: " + obj.track);
		var slot_obj = slots.get(slot);
		if (loc == "remote" && obj.stream.id == slot_obj.remotestream.id) {
			if (change == "mute") {
				slot_obj.player.parentElement.classList.add("muted");
			}
			if (change == "unmute") {
				slot_obj.player.parentElement.classList.remove("muted");
			}
		}
	}
	function new_call(obj) {
		var slot = '';
		var slot_obj = null;
		for (var [s, o] of slots) {
			if (o.call == null) {
				slot = s;
				slot_obj = o;
				break;
			}
		}
		if (slot_obj == null) {
			obj.call.reject(486);
			return;
		}
		document.getElementById(slot + "-start_button").disabled = false;
		document.getElementById(slot + "-stop_button").disabled = false;
		if (secondStreamSource(slot) != "None") {
			document.getElementById(slot + "-second_stream_button").disabled = false;
		}
		document.getElementById(slot + "-state").value = "Incoming";
		document.getElementById(slot + "-callid").value = obj.call.callId();
		var siphdr = obj.call.getSipHeader("X-Aculab-WebRTC-Test");
		if (siphdr !== undefined) {
			document.getElementById(slot + "-recv-header").value = siphdr;
		}
		var from = obj.from + " [" + obj.type + "]";
		if (obj.offeringVideo) {
			from += " (offering video)";
		}
		if (obj.canReceiveVideo) {
			from += " (wants video)";
		}
		document.getElementById(slot + "-remote").value = from;
		document.getElementById(slot + "-target-type").disabled = true;
		document.getElementById(slot + "-target").disabled = true;
		slot_obj.call = obj.call;
		slot_obj.inbound = true;
		
		slot_obj.call.onDisconnect = call_disconnected.bind(null, slot);
		slot_obj.call.onRinging = ringing.bind(null, slot);
		slot_obj.call.onMedia = gotmedia.bind(null, slot);
		slot_obj.call.onMediaRemove = mediaremove.bind(null, slot);
		slot_obj.call.onLocalMediaRemove = localmediaremove.bind(null, slot);
		slot_obj.call.onConnecting = connecting.bind(null, slot);
		slot_obj.call.onConnected = connected.bind(null, slot);
		slot_obj.call.onError = handle_error.bind(null, slot);
		slot_obj.call.onLocalVideoMute = handleVideoMuteUnmute.bind(null, slot, "local", "mute");
		slot_obj.call.onLocalVideoUnmute = handleVideoMuteUnmute.bind(null, slot, "local", "unmute");
		slot_obj.call.onRemoteVideoMute = handleVideoMuteUnmute.bind(null, slot, "remote", "mute");
		slot_obj.call.onRemoteVideoUnmute = handleVideoMuteUnmute.bind(null, slot, "remote", "unmute");

		var player = slot_obj.player;
		if (player.canPlayType('audio/wav')) {
			if (!slot_obj.gotremotestream) {
				player.loop = 'loop';
				player.src = 'media/ringing.wav';
				player.type="audio/wav";
				player.load();
				var p = player.play();
				if (p !== undefined) {
					p.catch(error => {});
				}
			}
		} else {
			console.log("browser can't play audio/wav, so no ringing will be heard");
		}
		slot_obj.call.ringing();
		if (auto_accept) {
			start_call(slot);
		}
	}
	function incomingState(state) {
		if (state.ready) {
			//document.getElementById("unreg_button").disabled = false;
			document.getElementById("reg_state").value = "Incoming enabled";
		} else {
			//document.getElementById("unreg_button").disabled = false;
			var reg_state = "Not ready for incoming - " + state.cause;
			if (state.retry) {
				reg_state = reg_state + ' - retrying';
			}
			document.getElementById("reg_state").value = reg_state
		}
	}
	function register() {
		token = document.getElementById("token").value;
		if (acc) {
			try {
				acc.enableIncoming(token);
			}
			catch(err) {
				alert("Error: " + err);
				return;
			}
			document.getElementById("reg_state").value = "Enabling Incoming";
			document.getElementById("unreg_button").disabled = false;
			inbound_enabled = true;
		} else {
			document.getElementById("reg_state").value = "Client not found";
		}
	}
	function unregister() {
		if (acc) {
			document.getElementById("unreg_button").disabled = true;
			document.getElementById("reg_state").value = "Disabling Incoming";
			acc.disableIncoming();
			inbound_enabled = false;
		} else {
			document.getElementById("reg_state").value = "No cloud client";
		}
	}
	function start_client(cloud, webRtcAccessKey, clientId, logLevel) {
		if (acc) {
			return;
		}
		if (AculabCloudClient.isSupported()) {
			try {
				acc = new AculabCloudClient(cloud, webRtcAccessKey, clientId, logLevel);
				let peerConnectionConfiguration = {}
                                iceTransportPolicy = document.getElementById("iceTransportPolicy").value;
                                disableTurnServers = document.getElementById("disableTurnServers").value;
                                iceCandidatePoolSize = parseInt(document.getElementById("iceCandidatePoolSize").value);
				if (iceTransportPolicy != "undefined") {
                                        peerConnectionConfiguration.iceTransportPolicy = iceTransportPolicy;
				}
				if (disableTurnServers == "true") {
                                        peerConnectionConfiguration.iceServers = [];
				}
				if (iceCandidatePoolSize != 0) {
                                        peerConnectionConfiguration.iceCandidatePoolSize = iceCandidatePoolSize;
				}
				if (Object.keys(peerConnectionConfiguration).length > 0) {
					acc.setPeerConnectionConfiguration(peerConnectionConfiguration);
				}
			}
			catch(err) {
				acc = null;
				alert("Error: " + err)
			}
			if (acc) {
				acc.maxConcurrent = slots.size;
				acc.onIncoming = new_call;
				acc.onIncomingState = incomingState;
				document.getElementById("reg_button").disabled = false;
				document.getElementById("reg_state").value = "Incoming disabled";
				startStats();
			} else {
				document.getElementById("reg_state").value = "Error creating cloud client";
			}
		} else {
			document.getElementById("reg_state").value = "not supported by this browser";
		}
	}
	function make_client() {
		cloudObj = document.getElementById("cloud");
		cloud = cloudObj.value
		if (cloud == "") {
			cloud = document.getElementById("cloud-other").value;
		}
		webRtcAccessKeyObj = document.getElementById("webRtcAccessKey");
		clientIdObj = document.getElementById("clientId");
		logLevelObj = document.getElementById("logLevel");
		start_client(cloud, webRtcAccessKeyObj.value, clientIdObj.value, parseInt(logLevelObj.value));
		if (!acc) {
			return;
		}
		cloudObj.disabled = true;
		handleCloudSelect();
		webRtcAccessKeyObj.disabled = true;
		clientIdObj.disabled = true;
		logLevelObj.disabled = true;
		document.getElementById("create_button").disabled = true;
		document.getElementById("del_button").disabled = false;
		document.getElementById("reg_button").disabled = false;
		for (var [s, obj] of slots.entries()) {
			obj.player = document.getElementById(s + '-player');
			obj.secondplayer = document.getElementById(s + '-remotesecondplayer');
			let v = obj.player;
			v.addEventListener("resize", ev => {
				let w = v.videoWidth;
				let h = v.videoHeight;

				if (w && h) {
					// TODO should the size be limited?
					v.style.width = w + "px";
					v.style.height = h + "px";
				}
			}, false);
			obj.player.load(); // do this early in response to user action to ensure we can play later
			obj.secondplayer.load(); // do this early in response to user action to ensure we can play later
			obj.localplayer = document.getElementById(s + '-localplayer');
			obj.localplayer.load(); // do this early in response to user action to ensure we can play later
			obj.localsecondplayer = document.getElementById(s + '-localsecondplayer');
			obj.localsecondplayer.load(); // do this early in response to user action to ensure we can play later
			document.getElementById(s + '-start_button').disabled = false;
			set_codec_selector(s, 'audio');
			set_codec_selector(s, 'video');
		}
	}
	function dtor_client() {
		// TODO do we need a client stop function to kill all calls/registration
		// or should this only be allowed when no calls are present and incoming is disabled
		for (var obj of slots.values()) {
			if (obj.call) {
				return;
			}
		}
		if (inbound_enabled) {
			unregister();
		}
		stopStats();
		acc = null;
		cloudObj = document.getElementById("cloud");
		webRtcAccessKeyObj = document.getElementById("webRtcAccessKey");
		clientIdObj = document.getElementById("clientId");
		logLevelObj = document.getElementById("logLevel");
		cloudObj.disabled = false;
		handleCloudSelect();
		webRtcAccessKeyObj.disabled = false;
		clientIdObj.disabled = false;
		logLevelObj.disabled = false;
		document.getElementById("create_button").disabled = false;
		document.getElementById("del_button").disabled = true;
		document.getElementById("reg_button").disabled = true;
		document.getElementById("unreg_button").disabled = true;
		for (var s of slots.keys()) {
			document.getElementById(s + '-stop_button').disabled = true;
			document.getElementById(s + "-second_stream_button").disabled = true;
			document.getElementById(s + '-start_button').disabled = true;
		}
	}
	function handleCloudSelect() {
		cloudObj = document.getElementById("cloud");
		other_obj = document.getElementById("cloud-other");
		if (cloudObj.value != "") {
			other_obj.value="";
			other_obj.disabled = true;
		} else {
			other_obj.disabled = cloudObj.disabled;
		}
	}
	function get_token() {
		cloudObj = document.getElementById("cloud");
		cloud = cloudObj.value
		if (cloud == "") {
			cloud = document.getElementById("cloud-other").value;
		}
		clientId = document.getElementById("clientId").value;
		username = document.getElementById("cloud-username").value;
		password = document.getElementById("cloud-password").value;
		ttl = document.getElementById("ttl").value;
		if(ttl == '') {
			ttl = 3600;
		}

		enable_incoming = document.getElementById("enable-incoming").checked ? "true" : "false";
		call_client = document.getElementById("call-client").value;

		var data = new FormData();
		data.append("client_id", clientId);
		data.append("ttl", ttl);
		data.append("enable_incoming", enable_incoming);
		if (call_client != "") {
			data.append("call_client", call_client);
		}
		fetch(`https://ws-${cloud}.aculabcloud.net/webrtc_generate_token`, {
			method: 'POST',
			headers: {
				"Authorization": "Basic " + btoa(cloud + "/" + username + ":" + password)
			},
			body: data
		})
		.then(async response => {
			const isJson = response.headers.get('content-type')?.includes('application/json');
			const data = isJson ? await response.json() : null;

			// check for error response
			if (!response.ok) {
				// get error message from body or default to response status
				const error = (data && data.error && data.error.text) || `HTTP ${response.status}`;
				return Promise.reject(error);
			}
			document.getElementById("token").value = data.token;
		})
		.catch(error => {
			document.getElementById("token").value = `Error: ${error}`;
			console.error('There has been a problem with your fetch operation:', error);
		});
	}
	function forceDisconnect() {
		acc.closeConnection();
	}
	function secondStreamSource(slot) {
		return document.getElementById(slot + "-second-stream-source").value;
	}
	</script>
</head>
<body onload="initialise()">
	<style>
	video {
		width: 320px;
		height: 240px;
		border: 1px solid black;
	}
	td.muted {
		position: relative;
	}
	td.muted:before {
		position: absolute;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		content: 'video paused';
		color: white;
		background: rgba(0, 0, 0, 0.8);
		/* Center vertically and horizontally */
		display: flex;
		justify-content: center;
		align-items: center;
	}
	/* The switch - the box around the slider */
	.switch {
		position: relative;
		display: inline-block;
		width: 40px;
		height: 24px;
	}

	/* Hide default HTML checkbox */
	.switch input {
		opacity: 0;
		width: 0;
		height: 0;
	}

	/* The slider */
	.slider {
		position: absolute;
		cursor: pointer;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: #ccc;
		-webkit-transition: .4s;
		transition: .4s;
	}

	.slider:before {
		position: absolute;
		content: "";
		height: 16px;
		width: 16px;
		left: 4px;
		bottom: 4px;
		background-color: white;
		-webkit-transition: .4s;
		transition: .4s;
	}

	input:checked + .slider {
		background-color: #2196F3;
	}

	input:focus + .slider {
		box-shadow: 0 0 1px #2196F3;
	}

	input:checked + .slider:before {
		-webkit-transform: translateX(16px);
		-ms-transform: translateX(16px);
		transform: translateX(16px);
	}

	/* Rounded sliders */
	.slider.round {
		border-radius: 24px;
	}

	.slider.round:before {
		border-radius: 50%;
	}

	/* MediaTrack indicator lights */
	.led {
		height: 12px;
		width: 12px;
		border-radius: 50%;
		display: inline-flex;
		background-color: red; 
		transform: translate(0, 2px);  /* align with text */
	}

	.led.green {
		background-color: green;
	}

	</style>
    <h2>Aculab Cloud WebRTC demo</h2>
	<table>
		<tr>
			<td style="padding:10px">
				<table><tr><td>
					Cloud:
					<select id="cloud" onchange="handleCloudSelect()">
						<option value="0-0-0" selected="selected">0-0-0</option>
						<option value="0-2-0">0-2-0</option>
						<option value="1-2-0">1-2-0</option>
						<option value="2-2-0">2-2-0</option>
						<option value="3-2-0">3-2-0</option>
						<option value="4-0-0">4-0-0</option>
						<option value="4-0-1">4-0-1</option>
						<option value="">other</option>
					</select>
					<input id="cloud-other" size=10 value="" disabled=true>
					</td></tr><tr><td>WebRTC Access Key:
					<input id="webRtcAccessKey" size=40 value="jxctfdid7uf9lyotgzpry9r9q">
					</td></tr><tr><td>Client ID:
					<input id="clientId" size=40 value="client">
					</td></tr><tr><td>Log level:
					<select id="logLevel">
						<option>0</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option selected="selected">8</option>
					</select>
					</td></tr><tr><td>Ice Transport Policy:
					<select id="iceTransportPolicy">
						<option selected="selected">undefined</option>
						<option>all</option>
						<option>relay</option>
					</select>
					</td></tr><tr><td>Disable TURN servers:
					<select id="disableTurnServers">
						<option>true</option>
						<option selected="selected">false</option>
					</select>
					</td></tr><tr><td>Ice Candidate Pool Size:
					<select id="iceCandidatePoolSize">
						<option selected="selected">0</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option>8</option>
						<option>9</option>
						<option>10</option>
					</select>
					</td></tr><tr><td>
						<button id="create_button" type="button" onclick="make_client()">Create</button>
						<button id="del_button" type="button" onclick="dtor_client()" disabled=true>Destroy</button>
						<button id="dis_button" type="button" onclick="forceDisconnect()" >Disconnect</button>
					</td></tr><tr><td>
					&nbsp;
					</td></tr><tr><td>
						Incoming:
						<button id="reg_button" type="button" onclick="register()" disabled=true>Enable</button>
						<button id="unreg_button" type="button" onclick="unregister()" disabled=true>Disable</button>
					</td></tr><tr><td>
						<input id="reg_state" size=60 value="Not registered" disabled=true>
					</td></tr>
				</table>
			</td>
			<td style="padding:10px">
				<table>
					<tr><td>
					Cloud Username: <input id="cloud-username" size=40 value="cloud.testing@aculab.com">
					<td></tr>
					<tr><td>
					API Access Key: <input id="cloud-password" size=40 value="" type="password">
					</td></tr>
					<tr><td>
					TTL: <input id="ttl" size=10 value="3600" min="600" max="87600" type="number">
					</td></tr>
					<tr><td>
					Can enable incoming:
					<label class="switch">
						<input type="checkbox" id="enable-incoming" checked="checked">
						<span class="slider round"></span>
					</label>

					</td></tr>
					<tr><td>
					Call client: <input id="call-client" size=10 value="*">
					</td></tr>
					<tr><td>
					<button id="gen_token_button" type="button" onclick="get_token()">Generate token</button>
					</td></tr>
					<tr><td>
					Client token:
					<input id="token" size=40 value="">
					</td></tr>
				</table>
			</td>
		</tr>
		<tr><td colspan=2>&nbsp;</td></tr>
		<tr>
			<td style="padding:10px; border: 1px solid blue;">
				<table><tr><td>Caller</td><td>You</td></tr><tr><td>
				<video id="a-player" poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="a-localplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td></tr>
				<tr id="a-secondstreamtitle" style="visibility: collapse"><td>Remote second stream</td><td>Local second stream</td></tr><tr id="a-secondstreamplayers" style="visibility: collapse"><td>
				<video id="a-remotesecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="a-localsecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td></tr></table>
				<table><tr><td>
					Call:
					<select id="a-target-type">
						<option selected="selected">service</option>
						<option>client</option>
					</select>
					<input id="a-target" size=40 value="webrtcdemo">
					</td></tr><tr><td>
					Send SIP Header: <input id="a-header" size=60 value="">
					</td></tr><tr><td>
					Recv SIP Header: <input id="a-recv-header" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Remote:
					<input id="a-remote" size=40 value="" disabled=true>
					</td></tr><tr><td>
					State: <input id="a-state" size=60 value="Idle" disabled=true>
					</td></tr><tr><td>
					Connection: <input id="a-stats" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Call Id: <input id="a-callid" size=60 value="" disabled=true>
					</td></tr><tr><td>
					<button id="a-start_button" type="button" onclick="start_call('a')" disabled=true>Start</button>
					<button id="a-stop_button" type="button" onclick="stop_call('a')" disabled=true>Disconnect</button>
					<button id="a-second_stream_button" type="button" onclick="add_remove_stream('a')" disabled=true>Add Stream</button>
					&nbsp;Mute: 
					&nbsp;Mic: 
					<label class="switch">
						<input type="checkbox" id="a-mute-mic" onchange="mute_call('a')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="a-mic-led" class="led"></div>
					&nbsp;Cam: 
					<label class="switch">
						<input type="checkbox" id="a-mute-cam" onchange="mute_call('a')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="a-cam-led" class="led"></div>
					&nbsp;OutA: 
					<label class="switch">
						<input type="checkbox" id="a-mute-outa" onchange="mute_call('a')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="a-outa-led" class="led"></div>
					&nbsp;OutV: 
					<label class="switch">
						<input type="checkbox" id="a-mute-outv" onchange="mute_call('a')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="a-outv-led" class="led"></div>
				</td></tr><tr><td>
				<div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
					<table id="a-dtmf-buttons" style="display:inline-block">
						<tr>
							<td><button id="dtmf1" type="button" disabled=true onclick="send_dtmf('a','1')">1</button></td>
							<td><button id="dtmf2" type="button" disabled=true onclick="send_dtmf('a','2')">2</button></td>
							<td><button id="dtmf3" type="button" disabled=true onclick="send_dtmf('a','3')">3</button></td>
						</tr>
						<tr>
							<td><button id="dtmf4" type="button" disabled=true onclick="send_dtmf('a','4')">4</button></td>
							<td><button id="dtmf5" type="button" disabled=true onclick="send_dtmf('a','5')">5</button></td>
							<td><button id="dtmf6" type="button" disabled=true onclick="send_dtmf('a','6')">6</button></td>
						</tr>
						<tr>
							<td><button id="dtmf7" type="button" disabled=true onclick="send_dtmf('a','7')">7</button></td>
							<td><button id="dtmf8" type="button" disabled=true onclick="send_dtmf('a','8')">8</button></td>
							<td><button id="dtmf9" type="button" disabled=true onclick="send_dtmf('a','9')">9</button></td>
						</tr>
						<tr>
							<td><button id="dtmf10" type="button" disabled=true onclick="send_dtmf('a','*')">*</button></td>
							<td><button id="dtmf11" type="button" disabled=true onclick="send_dtmf('a','0')">0</button></td>
							<td><button id="dtmf12" type="button" disabled=true onclick="send_dtmf('a','#')">#</button></td>
						</tr>
					</table>
					<div style="display: inline-block">
						Local media constraints:
						<br>
						Audio:&nbsp;<select id="a-audio-constraints">
							<option selected>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="a-video-constraints">
							<option selected>true</option>
							<option>false</option>
							<option>qvga-exact</option>
							<option>qvga-ideal</option>
							<option>vga-exact</option>
							<option>vga-ideal</option>
							<option>xga-exact</option>
							<option>xga-ideal</option>
							<option>hd720-exact</option>
							<option>hd720-ideal</option>
							<option>hd1080-exact</option>
							<option>hd1080-ideal</option>
						</select>
						<br>
						Second stream:
						<br>
						Source:&nbsp;<select id="a-second-stream-source">
							<option selected>None</option>
							<option>Screen Share</option>
						</select>
					</div>
					<div style="display: inline-block">
						Receive:
						<br>
						Audio:&nbsp;<select id="a-audio-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="a-video-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
					</div>
					<div style="display: inline-block">
						Bandwidth:
						<br>
						Audio:&nbsp;<select id="a-audio-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>256000</option>
							<option>128000</option>
							<option>64000</option>
							<option>32000</option>
							<option>16000</option>
							<option>8000</option>
						</select>
						<br>
						Video:&nbsp;<select id="a-video-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>128000</option>
							<option>256000</option>
							<option>512000</option>
							<option>1024000</option>
							<option>2048000</option>
							<option>4096000</option>
						</select>
					</div>
					<div style="display: inline-block">
						Preferred codec:
						<br>
						Audio:&nbsp;<select id="a-audio-codecs">
						</select>
						<br>
						Video:&nbsp;<select id="a-video-codecs">
						</select>
					</div>
				</div>
				</td></tr></table>
			</td>
			<td style="padding:10px; border: 1px solid blue;">
				<table><tr><td>Caller</td><td>You</td></tr><tr><td>
				<video id="b-player" poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="b-localplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<tr id="b-secondstreamtitle" style="visibility: collapse"><td>Remote second stream</td><td>Local second stream</td></tr><tr id="b-secondstreamplayers" style="visibility: collapse"><td>
				<video id="b-remotesecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="b-localsecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td></tr></table>
				<table><tr><td>
					Call:
					<select id="b-target-type">
						<option>service</option>
						<option selected="selected">client</option>
					</select>
					<input id="b-target" size=40 value="client">
					</td></tr><tr><td>
					Send SIP Header: <input id="b-header" size=60 value="">
					</td></tr><tr><td>
					Recv SIP Header: <input id="b-recv-header" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Remote:
					<input id="b-remote" size=40 value="" disabled=true>
					</td></tr><tr><td>
					State: <input id="b-state" size=60 value="Idle" disabled=true>
					</td></tr><tr><td>
					Connection: <input id="b-stats" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Call Id: <input id="b-callid" size=60 value="" disabled=true>
					</td></tr><tr><td>
					<button id="b-start_button" type="button" onclick="start_call('b')" disabled=true>Start</button>
					<button id="b-stop_button" type="button" onclick="stop_call('b')" disabled=true>Disconnect</button>
					<button id="b-second_stream_button" type="button" onclick="add_remove_stream('b')" disabled=true>Add Stream</button>
					&nbsp;Mute: 
					&nbsp;Mic: 
					<label class="switch">
						<input type="checkbox" id="b-mute-mic" onchange="mute_call('b')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="b-mic-led" class="led"></div>
					&nbsp;Cam: 
					<label class="switch">
						<input type="checkbox" id="b-mute-cam" onchange="mute_call('b')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="b-cam-led" class="led"></div>
					&nbsp;OutA: 
					<label class="switch">
						<input type="checkbox" id="b-mute-outa" onchange="mute_call('b')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="b-outa-led" class="led"></div>
					&nbsp;OutV: 
					<label class="switch">
						<input type="checkbox" id="b-mute-outv" onchange="mute_call('b')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="b-outv-led" class="led"></div>
				</td></tr><tr><td>
					<div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
						<table id="b-dtmf-buttons" style="display:inline-block">
						<tr>
							<td><button id="dtmf1" type="button" disabled=true onclick="send_dtmf('b','1')">1</button></td>
							<td><button id="dtmf2" type="button" disabled=true onclick="send_dtmf('b','2')">2</button></td>
							<td><button id="dtmf3" type="button" disabled=true onclick="send_dtmf('b','3')">3</button></td>
						</tr>
						<tr>
							<td><button id="dtmf4" type="button" disabled=true onclick="send_dtmf('b','4')">4</button></td>
							<td><button id="dtmf5" type="button" disabled=true onclick="send_dtmf('b','5')">5</button></td>
							<td><button id="dtmf6" type="button" disabled=true onclick="send_dtmf('b','6')">6</button></td>
						</tr>
						<tr>
							<td><button id="dtmf7" type="button" disabled=true onclick="send_dtmf('b','7')">7</button></td>
							<td><button id="dtmf8" type="button" disabled=true onclick="send_dtmf('b','8')">8</button></td>
							<td><button id="dtmf9" type="button" disabled=true onclick="send_dtmf('b','9')">9</button></td>
						</tr>
						<tr>
							<td><button id="dtmf10" type="button" disabled=true onclick="send_dtmf('b','*')">*</button></td>
							<td><button id="dtmf11" type="button" disabled=true onclick="send_dtmf('b','0')">0</button></td>
							<td><button id="dtmf12" type="button" disabled=true onclick="send_dtmf('b','#')">#</button></td>
						</tr>
					</table>
					<div style="display: inline-block">
						Local media constraints:
						<br>
						Audio:&nbsp;<select id="b-audio-constraints">
							<option selected>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="b-video-constraints">
							<option selected>true</option>
							<option>false</option>
							<option>qvga-exact</option>
							<option>qvga-ideal</option>
							<option>vga-exact</option>
							<option>vga-ideal</option>
							<option>xga-exact</option>
							<option>xga-ideal</option>
							<option>hd720-exact</option>
							<option>hd720-ideal</option>
							<option>hd1080-exact</option>
							<option>hd1080-ideal</option>
						</select>
						<br>
						Second stream:
						<br>
						Source:&nbsp;<select id="b-second-stream-source">
							<option selected>None</option>
							<option>Screen Share</option>
						</select>
					</div>
					<div style="display: inline-block">
						Receive:
						<br>
						Audio:&nbsp;<select id="b-audio-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="b-video-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
					</div>
					<div style="display: inline-block">
						Bandwidth:
						<br>
						Audio:&nbsp;<select id="b-audio-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>256000</option>
							<option>128000</option>
							<option>64000</option>
							<option>32000</option>
							<option>16000</option>
							<option>8000</option>
						</select>
						<br>
						Video:&nbsp;<select id="b-video-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>128000</option>
							<option>256000</option>
							<option>512000</option>
							<option>1024000</option>
							<option>2048000</option>
							<option>4096000</option>
						</select>
					</div>
					<div style="display: inline-block">
						Preferred codec:
						<br>
						Audio:&nbsp;<select id="b-audio-codecs">
						</select>
						<br>
						Video:&nbsp;<select id="b-video-codecs">
						</select>
					</div>
				</div>
				</td></tr></table>
			</td>
		</tr>
		<tr>
			<td style="padding:10px; border: 1px solid blue;">
				<table><tr><td>Caller</td><td>You</td></tr><tr><td>
				<video id="c-player" poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="c-localplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<tr id="c-secondstreamtitle" style="visibility: collapse"><td>Remote second stream</td><td>Local second stream</td></tr><tr id="c-secondstreamplayers" style="visibility: collapse"><td>
				<video id="c-remotesecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="c-localsecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td></tr></table>
				<table><tr><td>
					Call:
					<select id="c-target-type">
						<option>service</option>
						<option selected="selected">client</option>
					</select>
					<input id="c-target" size=40 value="client">
					</td></tr><tr><td>
					SendSIP Header: <input id="c-header" size=60 value="">
					</td></tr><tr><td>
					Recv SIP Header: <input id="c-recv-header" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Remote:
					<input id="c-remote" size=40 value="" disabled=true>
					</td></tr><tr><td>
					State: <input id="c-state" size=60 value="Idle" disabled=true>
					</td></tr><tr><td>
					Connection: <input id="c-stats" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Call Id: <input id="c-callid" size=60 value="" disabled=true>
					</td></tr><tr><td>
					<button id="c-start_button" type="button" onclick="start_call('c')" disabled=true>Start</button>
					<button id="c-stop_button" type="button" onclick="stop_call('c')" disabled=true>Disconnect</button>
					<button id="c-second_stream_button" type="button" onclick="add_remove_stream('c')" disabled=true>Add Stream</button>
					&nbsp;Mute: 
					&nbsp;Mic: 
					<label class="switch">
						<input type="checkbox" id="c-mute-mic" onchange="mute_call('c')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="c-mic-led" class="led"></div>
					&nbsp;Cam: 
					<label class="switch">
						<input type="checkbox" id="c-mute-cam" onchange="mute_call('c')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="c-cam-led" class="led"></div>
					&nbsp;OutA: 
					<label class="switch">
						<input type="checkbox" id="c-mute-outa" onchange="mute_call('c')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="c-outa-led" class="led"></div>
					&nbsp;OutV: 
					<label class="switch">
						<input type="checkbox" id="c-mute-outv" onchange="mute_call('c')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="c-outv-led" class="led"></div>
				</td></tr><tr><td>
					<div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
						<table id="c-dtmf-buttons" style="display:inline-block">
						<tr>
							<td><button id="dtmf1" type="button" disabled=true onclick="send_dtmf('c','1')">1</button></td>
							<td><button id="dtmf2" type="button" disabled=true onclick="send_dtmf('c','2')">2</button></td>
							<td><button id="dtmf3" type="button" disabled=true onclick="send_dtmf('c','3')">3</button></td>
						</tr>
						<tr>
							<td><button id="dtmf4" type="button" disabled=true onclick="send_dtmf('c','4')">4</button></td>
							<td><button id="dtmf5" type="button" disabled=true onclick="send_dtmf('c','5')">5</button></td>
							<td><button id="dtmf6" type="button" disabled=true onclick="send_dtmf('c','6')">6</button></td>
						</tr>
						<tr>
							<td><button id="dtmf7" type="button" disabled=true onclick="send_dtmf('c','7')">7</button></td>
							<td><button id="dtmf8" type="button" disabled=true onclick="send_dtmf('c','8')">8</button></td>
							<td><button id="dtmf9" type="button" disabled=true onclick="send_dtmf('c','9')">9</button></td>
						</tr>
						<tr>
							<td><button id="dtmf10" type="button" disabled=true onclick="send_dtmf('c','*')">*</button></td>
							<td><button id="dtmf11" type="button" disabled=true onclick="send_dtmf('c','0')">0</button></td>
							<td><button id="dtmf12" type="button" disabled=true onclick="send_dtmf('c','#')">#</button></td>
						</tr>
					</table>
					<div style="display: inline-block">
						Local media constraints:
						<br>
						Audio:&nbsp;<select id="c-audio-constraints">
							<option selected>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="c-video-constraints">
							<option selected>true</option>
							<option>false</option>
							<option>qvga-exact</option>
							<option>qvga-ideal</option>
							<option>vga-exact</option>
							<option>vga-ideal</option>
							<option>xga-exact</option>
							<option>xga-ideal</option>
							<option>hd720-exact</option>
							<option>hd720-ideal</option>
							<option>hd1080-exact</option>
							<option>hd1080-ideal</option>
						</select>
						<br>
						Second stream:
						<br>
						Source:&nbsp;<select id="c-second-stream-source">
							<option selected>None</option>
							<option>File</option>
							<option>Screen Share</option>
						</select>
					</div>
					<div style="display: inline-block">
						Receive:
						<br>
						Audio:&nbsp;<select id="c-audio-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="c-video-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
					</div>
					<div style="display: inline-block">
						Bandwidth:
						<br>
						Audio:&nbsp;<select id="c-audio-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>256000</option>
							<option>128000</option>
							<option>64000</option>
							<option>32000</option>
							<option>16000</option>
							<option>8000</option>
						</select>
						<br>
						Video:&nbsp;<select id="c-video-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>128000</option>
							<option>256000</option>
							<option>512000</option>
							<option>1024000</option>
							<option>2048000</option>
							<option>4096000</option>
						</select>
					</div>
					<div style="display: inline-block">
						Preferred codec:
						<br>
						Audio:&nbsp;<select id="c-audio-codecs">
						</select>
						<br>
						Video:&nbsp;<select id="c-video-codecs">
						</select>
					</div>
				</div>
				</td></tr></table>
			</td>
			<td style="padding:10px; border: 1px solid blue;">
				<table><tr><td>Caller</td><td>You</td></tr><tr><td>
				<video id="d-player" poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="d-localplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<tr id="d-secondstreamtitle" style="visibility: collapse"><td>Remote second stream</td><td>Local second stream</td></tr><tr id="d-secondstreamplayers" style="visibility: collapse"><td>
				<video id="d-remotesecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td><td>
				<video id="d-localsecondplayer" muted poster="./media/video_placeholder.png"></video>
				</td></tr></table>
				<table><tr><td>
					Call:
					<select id="d-target-type">
						<option>service</option>
						<option selected="selected">client</option>
					</select>
					<input id="d-target" size=40 value="client">
					</td></tr><tr><td>
					Send SIP Header: <input id="d-header" size=60 value="">
					</td></tr><tr><td>
					Recv SIP Header: <input id="d-recv-header" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Remote:
					<input id="d-remote" size=40 value="" disabled=true>
					</td></tr><tr><td>
					State: <input id="d-state" size=60 value="Idle" disabled=true>
					</td></tr><tr><td>
					Connection: <input id="d-stats" size=60 value="" disabled=true>
					</td></tr><tr><td>
					Call Id: <input id="d-callid" size=60 value="" disabled=true>
					</td></tr><tr><td>
					<button id="d-start_button" type="button" onclick="start_call('d')" disabled=true>Start</button>
					<button id="d-stop_button" type="button" onclick="stop_call('d')" disabled=true>Disconnect</button>
					<button id="d-second_stream_button" type="button" onclick="add_remove_stream('d')" disabled=true>Add Stream</button>
					&nbsp;Mute: 
					&nbsp;Mic: 
					<label class="switch">
						<input type="checkbox" id="d-mute-mic" onchange="mute_call('d')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="d-mic-led" class="led"></div>
					&nbsp;Cam: 
					<label class="switch">
						<input type="checkbox" id="d-mute-cam" onchange="mute_call('d')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="d-cam-led" class="led"></div>
					&nbsp;OutA: 
					<label class="switch">
						<input type="checkbox" id="d-mute-outa" onchange="mute_call('d')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="d-outa-led" class="led"></div>
					&nbsp;OutV: 
					<label class="switch">
						<input type="checkbox" id="d-mute-outv" onchange="mute_call('d')" disabled=true>
						<span class="slider round"></span>
					</label>
					<div id="d-outv-led" class="led"></div>
				</td></tr><tr><td>
					<div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
						<table id="d-dtmf-buttons" style="display:inline-block">
						<tr>
							<td><button id="dtmf1" type="button" disabled=true onclick="send_dtmf('d','1')">1</button></td>
							<td><button id="dtmf2" type="button" disabled=true onclick="send_dtmf('d','2')">2</button></td>
							<td><button id="dtmf3" type="button" disabled=true onclick="send_dtmf('d','3')">3</button></td>
						</tr>
						<tr>
							<td><button id="dtmf4" type="button" disabled=true onclick="send_dtmf('d','4')">4</button></td>
							<td><button id="dtmf5" type="button" disabled=true onclick="send_dtmf('d','5')">5</button></td>
							<td><button id="dtmf6" type="button" disabled=true onclick="send_dtmf('d','6')">6</button></td>
						</tr>
						<tr>
							<td><button id="dtmf7" type="button" disabled=true onclick="send_dtmf('d','7')">7</button></td>
							<td><button id="dtmf8" type="button" disabled=true onclick="send_dtmf('d','8')">8</button></td>
							<td><button id="dtmf9" type="button" disabled=true onclick="send_dtmf('d','9')">9</button></td>
						</tr>
						<tr>
							<td><button id="dtmf10" type="button" disabled=true onclick="send_dtmf('d','*')">*</button></td>
							<td><button id="dtmf11" type="button" disabled=true onclick="send_dtmf('d','0')">0</button></td>
							<td><button id="dtmf12" type="button" disabled=true onclick="send_dtmf('d','#')">#</button></td>
						</tr>
					</table>
					<div style="display: inline-block">
						Local media constraints:
						<br>
						Audio:&nbsp;<select id="d-audio-constraints">
							<option selected>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="d-video-constraints">
							<option selected>true</option>
							<option>false</option>
							<option>qvga-exact</option>
							<option>qvga-ideal</option>
							<option>vga-exact</option>
							<option>vga-ideal</option>
							<option>xga-exact</option>
							<option>xga-ideal</option>
							<option>hd720-exact</option>
							<option>hd720-ideal</option>
							<option>hd1080-exact</option>
							<option>hd1080-ideal</option>
						</select>
						<br>
						Second stream:
						<br>
						Source:&nbsp;<select id="d-second-stream-source">
							<option selected>None</option>
							<option>File</option>
							<option>Screen Share</option>
						</select>
					</div>
					<div style="display: inline-block">
						Receive:
						<br>
						Audio:&nbsp;<select id="d-audio-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
						<br>
						Video:&nbsp;<select id="d-video-receive">
							<option selected>undefined</option>
							<option>true</option>
							<option>false</option>
						</select>
					</div>
					<div style="display: inline-block">
						Bandwidth:
						<br>
						Audio:&nbsp;<select id="d-audio-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>256000</option>
							<option>128000</option>
							<option>64000</option>
							<option>32000</option>
							<option>16000</option>
							<option>8000</option>
						</select>
						<br>
						Video:&nbsp;<select id="d-video-bandwidth">
							<option selected>not set</option>
							<option>unlimited</option>
							<option>128000</option>
							<option>256000</option>
							<option>512000</option>
							<option>1024000</option>
							<option>2048000</option>
							<option>4096000</option>
						</select>
					</div>
					<div style="display: inline-block">
						Preferred codec:
						<br>
						Audio:&nbsp;<select id="d-audio-codecs">
						</select>
						<br>
						Video:&nbsp;<select id="d-video-codecs">
						</select>
					</div>
				</div>
				</td></tr></table>
			</td>
		</tr>
	</table>
</body>
</html>
